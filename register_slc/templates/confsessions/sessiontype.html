{% extends 'confsessions/base_session.html' %}
{% load i18n %}

{% block title %}
{% trans sessiontype.name %}.
{% endblock %}

{% block scripts %}
<script type="text/javascript">
	$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
		if(!options.crossDomain) {
			if(options.data) {
				options.data += "&";
			} else {
				options.data = "";
			}
			options.data += "csrfmiddlewaretoken={{csrf_token}}";
		}
	});

	function resetSessionButtons()
	{
		{% if user.is_authenticated %}
			{% for sess in sessiontype.session_set.all %}
				session_button = $('#btn_{{ sess.pk }}');
				$(session_button).addClass('button');
				{% if user.get_profile.unpaid %}
					$(session_button).text("Save");
				{% else %}
					$(session_button).text("Register");
				{% endif %}
			{% endfor %}
		{% endif %}
	}

	function sessionClicked(session_pk)
	{
		{% if user.get_profile.unpaid %}
			urlToCall = "/profiles/save_session/" + session_pk + "/{{ user.pk }}/";
		{% else %}
			urlToCall = "/sessions/register_session/" + session_pk +  "/{{ user.pk }}/"
		{% endif %}

		$.ajax({
			type: "POST",
			url: urlToCall,
			success: function(response) {
				resetSessionButtons();
				session_button = $('#btn_' + session_pk);
				$(session_button).removeClass("button");
				{% if user.get_profile.unpaid %}
					$(session_button).text("Saved");
				{% else %}
					$(session_button).text("Registered");
				{% endif %}
			}
		});
	}

	$(document).ready(function() {
		resetSessionButtons();
	});

</script>
{% endblock %}

{% block sessions %}
	<ul class ="sessions">
	{% for session in sessiontype.session_set.all %}
		<div class="modal">
			<div class="modal-header">
				<h3>{{ session.name }}</h3>
				<h4>{{ session.presenter}}</h4>
			</div>
			<div class="modal-body">
				<p id="tease_{{ session.pk }}">{{ session.teaser }} 
					<div id="clickread_{{ session.pk }}">Click to read full description...</div>
				</p> 
				<p id="desc_{{ session.pk }}">{{ session.description }}</p>
			</div>

			<div class="modal-footer">
			{% if session.has_spaces %}
				{% if user.is_authenticated %}
					{% if user.get_profile.unpaid %}
						<a id='btn_{{ session.pk }}' class='button' onclick="sessionClicked({{ session.pk }})">Save</a>
					{% else %}
						<a id='btn_{{ session.pk }}' class='button' onclick="sessionClicked({{ session.pk }})">Register</a>
					{% endif %}
				{% else %}
					<a href="{% url 'userena_signin' %}" class="button">Sign In</a>
				{% endif %} 
			{% else %}
				<span class="full" />
				<span id='btn_{{ session.pk }}' />
			{% endif %}
			</div>
		</div>
	{% endfor %}
	</ul>
	
	<div class="bottom-buttons">
		{% if prev_sessiontime %}
		<a href="/sessions/sessiontime/{{ prev_sessiontime.pk }}"><div class="button prev-button" >back</div></a>
		{% endif %}
		{% if next_sessiontime %}
		<a href="/sessions/sessiontime/{{ next_sessiontime.pk }}"><div class="button next-button">next</div></a>
		{% endif %}
	</div>
</div>
{% endblock %}

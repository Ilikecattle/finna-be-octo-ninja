{% extends 'confsessions/base_session.html' %}
{% load i18n %}

{% block title %}
{% trans sessiontype.name %}.
{% endblock %}

{% block scripts %}
<script type="text/javascript">
	$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
		if(!options.crossDomain) {
			if(options.data) {
				options.data += "&";
			} else {
				options.data = "";
			}
			options.data += "csrfmiddlewaretoken={{csrf_token}}";
		}
	});

	function set_full(session_button)
	{
		set_footer(session_button, 'full');
		$(session_button).text("Full");
	}

	function set_save(session_button)
	{
		set_footer(session_button, 'register');
		$(session_button).text("Save");
	}

	function set_register(session_button)
	{
		set_footer(session_button, 'register');
		$(session_button).text("Register");
	}

	function set_registered(session_button)
	{
		set_footer(session_button, 'registered');
		$(session_button).text("Registered");
	}

	function set_saved(session_button)
	{
		set_footer(session_button, 'registered');
		$(session_button).text("Saved");
	}

	function set_footer(session_button, classes_to_add)
	{
		modal_footer = $(session_button).parent();
		modal_footer.attr('class', 'modal-footer ' + classes_to_add);
	}

	function resetSessionButtons()
	{
		{% if user.is_authenticated %}
			{% for sess in sessiontype.session_set.all %}
				session_button = $('#btn_{{ sess.pk }}');
				{% if user.get_profile.unpaid %}
					set_save(session_button);
				{% else %}
					set_register(session_button);
				{% endif %}
				{% if not sess.has_spaces %}
					set_full(session_button);
				{% endif %}

			{% endfor %}
			{% if user.get_profile.unpaid %}
				{% for sess in user.get_profile.saved_sessions.all %}
					set_saved($('#btn_{{ sess.pk }}'));
				{% endfor %}
			{% else %}
				{% for sess in user.get_profile.get_registered_sessions %}
					set_registered($('#btn_{{ sess.pk }}'));
				{% endfor %}
			{% endif %}
		{% endif %}
	}

	function sessionClicked(session_pk)
	{
		{% if user.get_profile.unpaid %}
			urlToCall = "/profiles/save_session/" + session_pk + "/{{ user.pk }}/";
		{% else %}
			urlToCall = "/sessions/register_session/" + session_pk +  "/{{ user.pk }}/"
		{% endif %}

		$.ajax({
			type: "POST",
			url: urlToCall,
			success: function(response) {
				resetSessionButtons();
				session_button = $('#btn_' + session_pk);
				{% if user.get_profile.unpaid %}
					set_saved(session_button);
				{% else %}
					set_registered(session_button);
				{% endif %}
			}
		});
	}

	$(document).ready(function() {
		resetSessionButtons();
	});

</script>
{% endblock %}

{% block sessions %}
	<ul class ="sessions">
	{% for session in sessiontype.session_set.all %}
		<div class="modal">
			<div class="modal-header">
				<h3>{{ session.name }}</h3>
				<h4>{{ session.presenter}}</h4>
			</div>
			<div class="modal-body">
				<p id="tease_{{ session.pk }}">{{ session.teaser }} 
					<div id="clickread_{{ session.pk }}">Click to read full description...</div>
				</p> 
				<p id="desc_{{ session.pk }}">{{ session.description }}</p>
			</div>

			<div class="modal-footer">
				{% if user.is_authenticated %}
					{% if user.get_profile.unpaid %}
						<div id='btn_{{ session.pk }}' onclick="sessionClicked({{ session.pk }})">Save</div>
					{% else %}
						<div id='btn_{{ session.pk }}' onclick="sessionClicked({{ session.pk }})">Register</div>
					{% endif %}
				{% else %}
					<div href="{% url 'userena_signin' %}" class="button">Sign In</div>
				{% endif %} 
			</div>
		</div>
	{% endfor %}
	</ul>
	
	<div class="bottom-buttons">
		{% if prev_sessiontime %}
		<a href="/sessions/sessiontime/{{ prev_sessiontime.pk }}"><div class="button prev-button" >back</div></a>
		{% endif %}
		{% if next_sessiontime %}
		<a href="/sessions/sessiontime/{{ next_sessiontime.pk }}"><div class="button next-button">next</div></a>
		{% endif %}
	</div>
</div>
{% endblock %}

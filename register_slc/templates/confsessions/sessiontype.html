{% extends 'confsessions/base_session.html' %}
{% load i18n %}

{% block title %}
{% trans sessiontype.name %}.
{% endblock %}

{% block scripts %}
<script type="text/javascript">
	$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
		if(!options.crossDomain) {
			if(options.data) {
				options.data += "&";
			} else {
				options.data = "";
			}
			options.data += "csrfmiddlewaretoken={{csrf_token}}";
		}
	});

	$(document).ready(function() {
		{% if user.is_authenticated %}
			{% for obj in user.session_set.all %}
				$('#btn_{{ obj.pk }}').replaceWith("<div id='btn_{{ obj.pk }}'>Registered</div>");
				$('#li_{{ obj.sessiontype.pk }}').html('<a class="registered" href="#affix_{{ obj.pk }}">{{ obj.sessiontype.name }}</a>');
			{% endfor %}
		{% endif %}
		{% for obj in sessiontype.session_set.all %}
			$('#btn_{{ obj.pk }}').live('click', function() {
				console.log("CLICK");
				$.ajax({
					type: "POST",
					url: "/sessions/register_session/{{ obj.pk }}/{{ user.pk }}/",
					success: function(response) {
						{% for sess in sessiontype.session_set.all %}
							$('#btn_{{ sess.pk }}').replaceWith("<a id='btn_{{ sess.pk }}' class='button'>Register</a>");
						{% endfor %}
						$('#btn_{{ obj.pk }}').replaceWith("<div id='btn_{{ obj.pk }}'>Registered</div>");
						$('#li_{{ sessiontime.pk }}').html('<a class="registered" href="#affix_{{ obj.pk }}">{{ sessiontime.name }}</a>');
					}
				});
			});
		{% endfor %}
	});
</script>
{% endblock %}

{% block content %}
<div class="container clearfix">

	<ul id="reg-nav" class="clearfix">
		{% for sesstime in session_times %}
			<li class="sessiontime"><a href="/sessions/sessiontime/{{ sesstime.pk }}">{{ sesstime.name }}</a></li>
		{% endfor %}
	</ul>

	<ul class ="sessions">
	{% for session in sessiontype.session_set.all %}
		<div class="modal">
			<div class="modal-header">
				<h3>{{ session.name }}</h3>
				<h4>{{ session.presenter}}</h4>
			</div>
			<div class="modal-body">
				<p id="tease_{{ session.pk }}">{{ session.teaser }} 
					<div id="clickread_{{ session.pk }}">Click to read full description...</div>
				</p> 
				<p id="desc_{{ session.pk }}">{{ session.description }}</p>
			</div>

			<div class="modal-footer">
			{% if session.has_spaces %}
				{% if user.is_authenticated %}
					{% if user.get_profile.unpaid %}
						<a href="{% url 'userena_profile_edit' user.username %}" class='button'>Pay Now</a>
					{% else %}
						<a id='btn_{{ session.pk }}' class='button'>Register</a>
					{% endif %}
				{% else %}
					<a href="{% url 'userena_signin' %}" class="button">Sign In</a>
				{% endif %} 
			{% else %}
				<span class="full" />
				<span id='btn_{{ session.pk }}' />
			{% endif %}
			</div>
		</div>
	{% endfor %}
	</ul>
	
	<div class="bottom-buttons">
		{% if prev_sessiontime %}
		<a href="/sessions/sessiontime/{{ prev_sessiontime.pk }}"><div class="button prev-button" >back</div></a>
		{% endif %}
		{% if next_sessiontime %}
		<a href="/sessions/sessiontime/{{ next_sessiontime.pk }}"><div class="button next-button">next</div></a>
		{% endif %}
	</div>
</div>
{% endblock %}

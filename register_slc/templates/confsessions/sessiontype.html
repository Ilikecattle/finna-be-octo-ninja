{% extends 'confsessions/base_session.html' %}
{% load i18n %}

{% block title %}
{% trans sessiontype.name %}.
{% endblock %}

{% block content_title %}
	<h2 class="content-title">{{ sessiontype.name }}</h2>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
	$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
		if(!options.crossDomain) {
			if(options.data) {
				options.data += "&";
			} else {
				options.data = "";
			}
			options.data += "csrfmiddlewaretoken={{csrf_token}}";
		}
	});

	$(document).ready(function() {
		{% if user.is_authenticated %}
			{% for obj in user.session_set.all %}
				$('#btn_{{ obj.pk }}').replaceWith("<div id='btn_{{ obj.pk }}'>Registered</div>");
				$('#li_{{ obj.sessiontype.pk }}').html('<a class="registered" href="#affix_{{ obj.pk }}">{{ obj.sessiontype.name }}</a>');
			{% endfor %}
		{% endif %}
		{% for obj in sessiontype.session_set.all %}
			$('#btn_{{ obj.pk }}').live('click', function() {
				console.log("clicked");
				$.ajax({
					type: "POST",
					url: "/sessions/register_session/{{ obj.pk }}/{{ user.pk }}/",
					success: function(response) {
						{% for sess in sessiontype.session_set.all %}
							$('#btn_{{ sess.pk }}').replaceWith("<a id='btn_{{ sess.pk }}' class='btn btn-primary register'>Register</a>");
						{% endfor %}
						$('#btn_{{ obj.pk }}').replaceWith("<div id='btn_{{ obj.pk }}'>Registered</div>");
						$('#li_{{ sessiontime.pk }}').html('<a class="registered" href="#affix_{{ obj.pk }}">{{ sessiontime.name }}</a>');
					}
				});
			});
		{% endfor %}
	});
</script>
{% endblock %}

{% block content %}
<div class="container clearfix">

	<div class="span3 bs-docs-sidebar">
		<ul class="nav nav-list bs-docs-sidenav">
			{% for sesstype in sessiontypes %}
				<li id="li_{{ sessiontime.pk }}"><a class="register" href="/sessions/sessiontype/{{ sesstype.pk }}">{{ sesstype.name }}</a></li>
			{% endfor %}
		</ul>
	</div>

	<ul class ="sessions">
	{% for session in sessiontype.session_set.all %}
		<div class="modal">
			<div class="modal-header">
				<h3>{{ session.name }}<h3>
			</div>
			<div class="modal-body">
				<h4>{{ session.presenter}} </h4>
				<p id="tease_{{ session.pk }}">{{ session.teaser }} 
					<div id="clickread_{{ session.pk }}">Click to read full description...</div>
				</p> 
				<p id="desc_{{ session.pk }}">{{ session.description }}</p>
			</div>

			<div class="modal-footer">
				<p>Location:{{ session.location }} 
					{% if session.has_spaces %}
					<span class={{ session.capacity_color }}></span> &nbsp &nbsp 
					{% if user.is_authenticated %}
					{% if user.get_profile.unpaid %}
					<a href="{% url 'userena_profile_edit' user.username %}" class='btn btn-primary register'>Pay Now</a>
					{% else %}
					<a id='btn_{{ session.pk }}' class='btn btn-primary register'>Register</a>
					{% endif %}
					{% else %}
					<a href="{% url "userena_signin" %}" class="btn btn-primary register">Sign In</a>
					{% endif %} 
					{% else %}
					<span class="full" /> &nbsp &nbsp 
					<span id='btn_{{ session.pk }}' />
					{% endif %}
				</p>
			</div>
		</div>
	{% endfor %}
	</ul>
</div>
{% endblock %}

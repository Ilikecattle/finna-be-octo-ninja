{% extends 'confsessions/base_session.html' %}
{% load i18n static %}

{% block title %}
{% trans sessiontype.name %}
{% endblock %}

{% block scripts %}
<script type="text/javascript">
	$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
		if(!options.crossDomain) {
			if(options.data) {
				options.data += "&";
			} else {
				options.data = "";
			}
			options.data += "csrfmiddlewaretoken={{csrf_token}}";
		}
	});

	function set_full(session_button)
	{
		set_footer(session_button, 'full', "Full");
	}

	function set_save(session_button)
	{
		set_footer(session_button, 'register', "Save");
	}

	function set_register(session_button)
	{
		set_footer(session_button, 'register', "Register");
	}

	function set_registered(session_button)
	{
		set_footer(session_button, 'registered', "Registered");
	}

	function set_saved(session_button)
	{
		set_footer(session_button, 'registered', "Saved");
	}

	function set_footer(session_button, classes_to_add, text)
	{
		session_button.attr('class', 'session-footer ' + classes_to_add);
		session_button.text(text);
	}

	function resetSessionButtons(firstLoad)
	{
		{% if user.is_authenticated %}
			{% for sess in sessiontype.session_set.all %}
				session_button = $('#btn_{{ sess.pk }}');
				{% if user.get_profile.paid %}
					set_register(session_button);
				{% else %}
					set_save(session_button);
				{% endif %}
				{% if not sess.has_spaces %}
					set_full(session_button);
				{% endif %}

			{% endfor %}
			if(firstLoad) {
				{% if user.get_profile.paid %}
					{% for sess in user.get_profile.get_registered_sessions %}
						set_registered($('#btn_{{ sess.pk }}'));
					{% endfor %}
				{% else %}
					{% for sess in user.get_profile.saved_sessions.all %}
						set_saved($('#btn_{{ sess.pk }}'));
					{% endfor %}
				{% endif %}
			}
		{% endif %}
	}

	function sessionClicked(session_pk)
	{
		{% if user.get_profile.paid %}
			urlToCall = "/sessions/register_session/" + session_pk +  "/{{ user.pk }}/"
		{% else %}
			urlToCall = "/accounts/save_session/" + session_pk + "/{{user.pk}}/";
		{% endif %}

		$.ajax({
			type: "POST",
			url: urlToCall,
			success: function(response) {
				resetSessionButtons();
				session_button = $('#btn_' + session_pk);
				{% if user.get_profile.paid %}
					set_registered(session_button);
				{% else %}
					set_saved(session_button);
				{% endif %}
			}
		});
	}

	$(document).ready(function() {
		resetSessionButtons(true);
		$('.description').toggleClass('hide');
		$(".tease_btn").on('click', function() {
			$(this).prev('.description').toggleClass('hide');
			$(this).prev().prev('.teaser').toggleClass('hide');
		});
	});
</script>
{% endblock %}

{% block sessions %}
<div class ="row">
	<div class="col-lg-10 col-lg-offset-1 col-md-12">
		<ul class ="sessions">
		{% for session in sessiontype.session_set.all %}
			<div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
				<li class="session">
					<div class="session-header">
						<h3>{{ session.name }}</h3>
						<h4>{{ session.presenter}}</h4>
					</div>
					<div class="session-body">
						{% if session.teaser %}
						<p class="teaser">{{ session.teaser }}</p>
						{% endif %}
						<p class="description">{{ session.description }}</p>
						{% if session.teaser %}
						<button type="button" class="tease_btn btn btn-default btn-xs center-block">...</button>
						{% endif %}
					</div>

					<div id='btn_{{ session.pk }}' class="session-footer" onclick="sessionClicked({{ session.pk }})">
						{% if user.is_authenticated %}
							{% if user.get_profile.paid %}
								Register
							{% else %}
								Save
							{% endif %}
						{% else %}
							Sign In<a href="{% url 'userena_signin' %}"><span class='link-spanner'></span></a>
						{% endif %} 
					</div>
				</li>
			</div>
		{% endfor %}
		</ul>
	</div>
</div>

<div class="bottom-buttons">
	{% if prev_sessiontime %}
	<a href="/sessions/sessiontime/{{ prev_sessiontime.pk }}"><div class="button prev-button" >back</div></a>
	{% endif %}
	{% if next_sessiontime %}
	<a href="/sessions/sessiontime/{{ next_sessiontime.pk }}"><div class="button next-button">next</div></a>
	{% else %}
	<a href="{% url 'profiles_review' %}"><div class="button next-button">next</div></a>
	{% endif %}
</div>
{% endblock %}
